---
title: "MA 678 Midterm Project"
author: "Rose Determan"
date: "12/2/2021"

header-includes:
  - \usepackage{wrapfig}
  - \usepackage{lipsum}
  - \usepackage{titling}
  - \pretitle{\begin{flushleft}}
  - \posttitle{\end{flushleft}}  
  - \preauthor{\begin{flushleft}}
  - \postauthor{\end{flushleft}}  
  - \predate{\begin{flushleft}}
  - \postdate{\end{flushleft}}
  - \usepackage{graphicx}
  - \usepackage{float} 
  - \usepackage{indentfirst} 
  - \usepackage{grffile}
geometry: "left=0.8in,right=0.8in,top=.5in, bottom=.8in"
output: 
  pdf_document:
    keep_tex: true
    fig_caption: yes
---
**Quick Notes (not for final report)**
**Things I'm still working on: **
- Making the figures more presentable. I know that some of the titles are strangely placed, and I'll fix that for the final report.   
- Fixing the placement of figures and tables   
- Completing the appendix    

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, include = FALSE)
pacman::p_load(ggthemes, kableExtra, ggplot2, rstan, rstanarm, ggpubr)

options(warn = -1)

source("clean_data.R")
```

```{r Imports}
#set ggplot theme
theme_set(theme_tufte(base_size = 7.5))
#Begin import and filter
mdl_data <- f1 %>% dplyr::select(c(UniID, AHDaSyRb, AHDaSyRb_log, AFScorRb,AI2RhADa_log,
                            AInjAge, ANurLvlR_rc, ANurLvlR_rcc,
                            AVertInj, ASpinSrg, AAsscInj,AUMVAdm_rcc,ABMI_st)) %>%
               filter(AInjAge != "0-14y") %>%
               filter(ANurLvlR_rc != "S" & ANurLvlR_rc != "U" & ANurLvlR_rc != "L"& ANurLvlR_rcc != "U") %>%
               na.omit()

w = 6
h= 6/1.62
```

# Abstract
Spinal cord injuries (SCI) are costly and lifelong medical conditions. The first weeks and months after an injury are crucial to recovery, but many variables impact the timeline of patient recovery. Both hospitals and patients can benefit from an accurate prediction of length of stay. In the following analysis, I have modeled the days spent hospitalized in inpatient rehabilitation following an injury using a fixed effect linear model and then a multi-level linear model. Ovarall, although still imperfect, the mixed effect model is more effective and accurate. 

# Introduction
Spinal cord injuries (SCI) can be an extremely serious condition where the spinal cord is damaged and has a decreased ability to send and receive nerve signals. Symptoms can include paralysis, pain or pressure in head, neck, or back, weakness and/or inability to move any part of the body, and difficulty breathing (Mayo Clinic, 2021).  In the United States, in 2021, it is estimated that there are approximately 54 cases of SCI per 1 million (Jain et al., 2015).  The spinal cord is divided into neurological segments. For analysis, the cervical and thoracic segments have been selected. Please refer to the appendix for a diagram of the spinal cord for reference. Each segment roughly corresponds to muscle groups and functions, and damage at a higher level likely indicates more serious impairment. For example, if there is an injury at the C4 level, the individual likely will have weak deltoids (in the shoulder region) and reduced strength and sensation everywhere below this region (Young, 2021).    

Since 1973 the National Spinal Cord Injury Model Systems have been collecting data in a database. The database is well managed and extensively documented. The data come from 29 facilities across the United States. The database includes information on 32,159 individuals from 1972 to 2016 and includes a variety of fields which include, for example, injury year, age at injury, sex, use of mechanical ventilation, functional independence scores, ASIA motor index scores, and ASIA sensory scores.  This report focus on the modeling the number of days that a patient is hospitalized in inpatient rehabilitation. This is the time after a patient has been treated medically/surgically and before they are discharged from care. This information is relevant to hospitals, so they are able to plan treatment for patients and estimate the number of patients they can care for in a given time. This information is also relevant to patients and their families, so they can also plan the next steps in the patient's recovery.   

# Methods
First, I selected relevant variables which are listed in the table. 
```{r Variable Definitions, include=TRUE}
vars <- read.csv("variables.csv")
kable(vars, "latex") %>%
   column_spec(1, width = "10em") %>%
   column_spec(2, width = "35em") %>%
   column_spec(3, width = "15em") %>%
   kable_styling(font_size = 7.5)
```

```{r Density Figure}
 ggplot(mdl_data)+
   geom_density(mapping = aes(x = AHDaSyRb_log, group = ANurLvlR_rcc),alpha = 0.25)+
   labs(title = "Density of log(Days) Hospitalized: Inpatient Rehabilitation")+
   ylab("Density") + xlab("log(Days Hospitalized in Rehabilitation)")
ggsave("density.png", width = w, height = h )

```
\begin{figure}{H}
  \centering
    \includegraphics[width=\linewidth]{density.png}
  \caption{Density of log(days) hospitalized in inpatient  acute and subacute rehabilitation unit. This excludes individuals who were never admitted either due to recovery or death. Each line represents a distribution of log days for a given neurologic level of injury.}
\end{figure}
  
Although the dataset was well organized and documented, I removed missing values and completed some centering, scaling, and recoding of variables. Any modifications can be found in the ```clean_data.R``` file, and brief notes are listed in the table. I selected cervical and thoracic injuries, since there were 607 lumbar injuries and 9 sacral injuries listed, and there are 4582 and 2510 cervical and thoracic injuries in the complete data set. In addition, individuals 0-14y were excluded from the analysis due to a high volume of missing data. After removing the missing data and the excluded variables, the dataset includes 5104 individuals with injuries from 2006 to 2016. Next, I fit a random effect model to predict log(days hospitalized in inpatient rehab) with a random intercept based on neurologic level of injury and a random slope for the vertebral injury variable also based on neurologic level of injury. I anticipate that the level of injury will impact the "baseline" of days hospitalized and different levels of injury would also have a varied impact on the influence of an additional injury on the log(days hospitalized in inpatient rehab). The models were evaluated using posterior predictive checks and leave-one-out validataion (loo). 

# Results
### Exploratory Data Analysis


```{r eda fig }
inj_hsp <- ggplot(mdl_data, aes(y= AHDaSyRb_log, x = AI2RhADa_log)) +
           geom_point(alpha = 0.1) + ylab("log(Days) Inpatient Rehab") + xlab("log(Days) Injury to 1st Admit")

bmi <- ggplot(mdl_data, aes(y= AHDaSyRb_log, x = ABMI_st)) +
           geom_point(alpha = 0.1) + ylab("log(Days) Inpatient Rehab") + xlab("Centered and Scaled BMI")

f_scr <- ggplot(mdl_data, aes(y= AHDaSyRb_log, x = AFScorRb)) +
           geom_point(alpha = 0.1) + ylab("log(Days) Inpatient Rehab") + xlab("Functional Independence Score")

age <- ggplot(mdl_data, aes(y= AHDaSyRb_log, x = AInjAge)) +
           geom_boxplot(notch = TRUE) + ylab("log(Days) Inpatient Rehab") + xlab("Age (years)")

vert <- ggplot(mdl_data, aes(y= AHDaSyRb_log, x = AVertInj)) +
           geom_boxplot(notch = TRUE) + ylab("log(Days) Inpatient Rehab") + xlab("Vertebral Injury")

spn <- ggplot(mdl_data, aes(y= AHDaSyRb_log, x = ASpinSrg)) +
           geom_boxplot(notch = TRUE) + ylab("log(Days) Inpatient Rehab") + xlab("Spinal Surgery")

assc <- ggplot(mdl_data, aes(y= AHDaSyRb_log, x = AAsscInj)) +
           geom_boxplot(notch = TRUE) + ylab("log(Days) Inpatient Rehab") + xlab("Associated Injury")


vent <- ggplot(mdl_data, aes(y= AHDaSyRb_log, x = AUMVAdm_rcc)) +
           geom_boxplot(notch = TRUE) + ylab("log(Days) Inpatient Rehab") + xlab("Use of Mechhanical Ventilation")


eda_fig <- ggarrange(inj_hsp, bmi, f_scr, age, vert, spn, assc, vent, ncol = 4, nrow = 2, align = 'v')

ggsave("eda_fig.png", eda_fig, width = w,  height = h, units = "in")

```

\begin{figure}{H}
  \centering
    \includegraphics[width=\linewidth]{eda_fig.png}
  \caption{Selected variables compared to log(days) hospitalized in inpatient rehab.}
\end{figure}
  
  
  
## Models
As mentioned, I fit to models to examine the differences between the fixed effect model and the random effect model. For both, I used the package Stan to use bayesian methods for the regression. Below are figures that summarize the models. 
```{r Fixed Model}
f_mdl <- stan_glm(formula = AHDaSyRb_log ~ AI2RhADa_log + ABMI_st +  AInjAge + AFScorRb + AUMVAdm_rcc + AVertInj+ ASpinSrg+ AAsscInj +  ANurLvlR_rcc, data =  mdl_data, refresh = 0, iter = 6000)

fix_pp <- pp_check(f_mdl,nreps = 100)

params <- names(f_mdl$coefficients)
fix_sp <- stan_plot(f_mdl, point_est = "mean", show_density = TRUE,ci_level = 0.95,outer_level = 0.995,pars = params[2:12], fill_color = "White", outline_color = "#e41a1c")
```
```{r Random Model}
#r_mdl <-stan_lmer(formula = AHDaSyRb_log ~  AI2RhADa_log + ABMI_st +  AInjAge + AFScorRb + AUMVAdm_rcc + AVertInj+ ASpinSrg+ AAsscInj + (1 + AI2RhADa_log | ANurLvlR_rcc) ,data = mdl_data, iter= 6000, chains = 5, control = list(adapt_delta = 0.999999))
#saveRDS(r_mdl, "r_mdl.rds")
r_mdl <- readRDS("C:/Users/RoseDeterman/2021_Fall/MA678/MA678-project-SCI/r_mdl.rds")
ran_pp <- pp_check(r_mdl,nreps = 100) 

params <- names(r_mdl$coefficients)
r_sp <- stan_plot(r_mdl, point_est = "mean", show_density = TRUE,ci_level = 0.95,outer_level = 0.995,pars = params[2:12], fill_color = "White", outline_color = "#377eb8")
```
```{r pp_checks}
pp_check_plt <- ggarrange(fix_pp, ran_pp, ncol = 1, common.legend = TRUE, labels = c("PP Check: Fixed Effect Model","PP Check: Random Effect Model" ))
ggsave("pp_plot.png", pp_check_plt, width = w, height = h)
```
\begin{figure}{H}
  \centering
    \includegraphics[width=\linewidth]{pp_plot.png}
  \caption{Each plot shows the distribution of the response variable log(days) and the distribution of the 100 posterior predicted responses. Both models seem to approximate the distribution well. }
\end{figure}


A leave one out cross validation that compares the fixed effect model and the random effect model shows that the random effect model is a better fit based on an ELPD value that is 20 points higher than the fixed effect model. The ELPD is the theoretical expected log point-wise predictive density of the model. The ```p_loo``` value returned from the validation indicates the number of "effective parameters." In the random effect model, approximately 85% (44/52) of the parameters are effective while in the fixed effect model, the ```p_loo``` value is larger than the number of parameters that were estimated which indicates weak predictive power of the model. 

```{r stan plots}
param_plt <- ggarrange(fix_sp, r_sp, ncol = 1, common.legend = TRUE, labels = c("Parameter Estimates: Fixed Effect Model","Parameter Estimates: Random Effect Model" ))
ggsave("param_plot.png", param_plt, width = w+1, height = h+1)
```
\begin{figure}{H}
  \centering
    \includegraphics[width=\linewidth]{param_plot.png}
  \caption{Each plot shows the parameter estimate and density for the nine parameters that are fit in both models. The parameter estimates are largely similar for both models. Interestingly, the estimate for those 75 and older is negative, so individuals in this group spend less time in rehabilitation than someone who is 15-29 years old. It also seems that spinal surgery and associated injuries do not play a strong role in the length of time in rehab.  }
\end{figure}


```{r, include=TRUE}
#year = 2013
#AFScorRB = 13
#AI2RhADa_log = 2.7
#BMI = 0 
#Age = 15-29y
#AUMVAdm_rcc = 0
#AVertInj = 1
#AAsscInj  =0 
#ASpinSrg = 1


#ANurLvlR_rcc = C01, C04, T04, T10
#beep()
pred <- data.frame("AFScorRb" = rep(c(13), times = 6),
                   "AI2RhADa_log" = rep(2.7, times = 6), 
                   "ABMI_st" = rep(0, times = 6),
                   "AInjAge" = rep("15-29y", times = 6),
                   "AUMVAdm_rcc" = rep(as.factor(0), times =6),
                   "AVertInj" = rep(as.factor(1), times =6),
                   "AAsscInj" = rep(as.factor(0), times = 6),
                   "ASpinSrg" = rep(as.factor(1), times = 6),
                   "ANurLvlR_rcc" = c("C01", "C04", "C07", "T01", "T04", "T10"))

pred_res <- c()
for (x in c(1:6)){
  r_pred <- posterior_predict(r_mdl, pred[x,], draws = 1000)
  pred_res <- rbind(pred_res, c(pred[x,9],round(mean(r_pred),2), round(sd(r_pred),2), round(mean(exp(r_pred)),2),round(sd(exp(r_pred)),2)))
}
pred_res <- data.frame(pred_res)
names(pred_res) <- c("Injury Level", "Mean log(days)", "Std.Dev. log(days)", "Mean days","Std.Dev. days")

kable(pred_res, "latex") %>%
   kable_styling(font_size = 7.5)
```

Using posterior prediction, I have predicted the estimated log(days hospitalized in inpatient rehab) for a patient with average or most common features and different levels of injury. The features were as follows:
Independence Score = 13; Log days from injury to first hospital admission = 2.7; Standardized BMI = 0; Age = 15-19y; Ventilator use = 0; Vertebral injury = 1; Associated injury = 0; Spinal surgery = 1; Neurological level of injury = C01, C04, C07, T01, T04, T10. 


# Discussion
In the random effect model, there were several elements that were surprising and should be investigated further. 
It was surprising to that patients with lower levels of injury (less of their body is impacted) were predicted to have longer stays. Maybe this is because they have more function, so there are more areas where they can improve and progress, while individuals with high levels of injuries are more limited. It should also be noted that these estimations also have large standard deviations which indicate a larger degree of uncertainty. Additionally, I was not expecting that individuals in the 75+ age group would have a shorter duration of rehab hospitalization. Perhaps this is due to a lack of data for this population. SCIs are most common in young people, and in the dataset used for the models less than 5% of patients were in the 75+ group. 


# Works Cited
Chen, Yuying. National Spinal Cord Injury Model Systems Database. Version 2016ARPublic. Birmingham, AL: National Spinal Cord Injury Statistical Center [distributor]. https://doi.org/10.17605/OSF.IO/NP24C. Accessed 28 October 2021. 

Jain, N. B., Ayers, G. D., Peterson, E. N., Harris, M. B., Morse, L., O’Connor, K. C., & Garshick, E. (2015). Traumatic Spinal Cord Injury in the United States, 1993–2012. JAMA, 313(22), 2236–2243. https://doi.org/10.1001/jama.2015.6250

Spinal cord injury—Symptoms and causes. (October 2, 2021). Mayo Clinic. Retrieved November 19, 2021, from https://www.mayoclinic.org/diseases-conditions/spinal-cord-injury/symptoms-causes/syc-20377890

Young, Wise (2021). Spinal Cord Injury Levels & Classification. Travis Roy Foundation. Retrieved November 29, 2021 from https://www.travisroyfoundation.org/sci/resources/spinal-cord-injury-levels-classification/

# Appendix: 
## Spine diagram

\begin{figure}{H}
  \centering
    \includegraphics[width=\linewidth]{Overview-of-the-Different-Parts-of-the-Vertebral-Column-1-600x543.jpg}
\end{figure}

## Summary of fixed effect model
```{r, include = TRUE}
summary(f_mdl)
```


## Summary of mixed effect model
```{r, include=TRUE}
summary(r_mdl)
```


## Results/Output of LOO
```{r Loo, include = TRUE}
loo_f <- loo(f_mdl)
loo_r <- loo(r_mdl)
#loo_compare(loo_f,loo_r )
#loo_r
#loo_f
```

